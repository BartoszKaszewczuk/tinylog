<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project name="tinylog" default="all">
	
	<property name="version" value="0.7" />
	
	<property name="root" location=".." />
	
	<property name="bin" location="${root}/tinylog/bin" />
	<property name="src" location="${root}/tinylog/src" />
	
	<property name="log4j" location="${root}/log4j-facade" />
	<property name="log4j.bin" location="${log4j}/bin" />
	<property name="log4j.src" location="${log4j}/src" />
	
	<property name="tests" location="${root}/tests" />
	<property name="tests.bin" location="${tests}/bin" />
	<property name="tests.src" location="${tests}/src" />
	<property name="tests.lib" location="${tests}/lib" />
		
	<property name="ext" location="${root}/ext" />
	<property name="ext.conf" location="${ext}/conf" />
	<property name="ext.lib" location="${ext}/lib" />
	<property name="ext.lib.checkstyle" location="${ext.lib}/checkstyle" />
	<property name="ext.lib.findbugs" location="${ext.lib}/findbugs" />
	<property name="ext.lib.junit" location="${ext.lib}/junit" />
	
	<property name="dist" location="${root}/dist" />
	<property name="dist.docs" location="${dist}/docs" />
	<property name="dist.jar" location="${dist}/jar" />

	<path id="junit.classpath">
		<fileset dir="${ext.lib.junit}">
			<include name="*.jar" />
		</fileset>
	</path>

	<taskdef resource="checkstyletask.properties">
		<classpath>
			<fileset dir="${ext.lib.checkstyle}">
				<include name="*.jar" />
			</fileset>
		</classpath>
	</taskdef>

	<taskdef name="findbugs" classname="edu.umd.cs.findbugs.anttask.FindBugsTask">
		<classpath>
			<fileset dir="${ext.lib.findbugs}">
				<include name="*.jar" />
			</fileset>
		</classpath>
	</taskdef>

	<target name="clean">
		<delete dir="${bin}" />
		<delete dir="${log4j.bin}" />
		<delete dir="${tests.bin}" />
	</target>

	<target name="makedir">
		<mkdir dir="${bin}" />
		<mkdir dir="${log4j.bin}" />
		<mkdir dir="${tests.bin}" />
	</target>

	<target name="compile" depends="clean, makedir">
		<javac srcdir="${src}" destdir="${bin}" includeantruntime="false" target="1.5" />
		<javac srcdir="${log4j.src}" destdir="${log4j.bin}" includeantruntime="false" target="1.5">
			<classpath location="${bin}" />
		</javac>
		<javac srcdir="${tests.src}" destdir="${tests.bin}" includeantruntime="false" target="1.5" debug="true" debuglevel="source,lines">
			<classpath refid="junit.classpath" />
			<classpath location="${bin}" />
			<classpath><fileset dir="${tests.lib}" includes="*.jar" /></classpath>
		</javac>
	</target>
	
	<target name="jar" depends="compile">
		<mkdir dir="${dist.jar}" />
		<delete>
			<fileset dir="${dist.jar}" />
		</delete>
		<jar destfile="${dist.jar}/tinylog.jar">
			<fileset dir="${bin}" />
		</jar>
		<zip destfile="${dist.jar}/tinylog-src.zip">
			<fileset dir="${src}" />
		</zip>
		<zip destfile="${dist.jar}/tinylog-${version}.zip" level="9">
			<fileset dir="${dist.jar}">
				<include name="tinylog.jar" />
				<include name="tinylog-src.zip" />
			</fileset>
			<fileset dir="${root}">
				<include name="License.txt" />
				<include name="ReadMe.txt" />
			</fileset>
		</zip>
		<jar destfile="${dist.jar}/log4j-facade.jar">
			<fileset dir="${log4j.bin}" />
		</jar>
		<zip destfile="${dist.jar}/log4j-facade-src.zip">
			<fileset dir="${log4j.src}" />
		</zip>
		<zip destfile="${dist.jar}/log4j-facade-${version}.zip" level="9">
			<fileset dir="${dist.jar}">
				<include name="tinylog.jar" />
				<include name="log4j-facade.jar" />
				<include name="log4j-facade-src.zip" />
			</fileset>
			<fileset dir="${root}">
				<include name="License.txt" />
			</fileset>
			<fileset dir="${log4j}">
				<include name="ReadMe.txt" />
			</fileset>
		</zip>
		<zip destfile="${dist.jar}/tinylog-${version}-src.zip" level="9">
			<fileset dir="${root}">
				<exclude name=".*/**" />
				<exclude name="dist/**" />
			</fileset>
		</zip>
	</target>
	
	<target name="docs" depends="compile">
		<delete dir="${dist.docs}" />
		<mkdir dir="${dist.docs}" />
		<javadoc destdir="${dist.docs}" use="true" access="public" windowtitle="tinylog ${version}">
			<doctitle>tinylog ${version} - API Specification</doctitle>
			<packageset dir="${src}" />
			<classpath>
				<dirset dir="${bin}" />
			</classpath>
			<link href="http://download.oracle.com/javase/6/docs/api/" offline="true" packagelistloc="${ext.conf}" />
		</javadoc>
	</target>

	<target name="check" depends="compile">
		<checkstyle config="${ext.conf}/tinylog-checkstyle.xml">
			<fileset dir="${src}" includes="**/*.java" />
			<fileset dir="${tests.src}" includes="**/*.java" />
			<formatter type="plain" usefile="false" />
		</checkstyle>
		<findbugs home="${ext.lib.findbugs}" output="text">
			<sourcepath>
				<dirset>
					<include name="${src}" />
					<include name="${tests.src}" />
				</dirset>
			</sourcepath>
			<fileset>
				<include name="${bin}" />
				<include name="${tests.bin}" />
			</fileset>
		</findbugs>
	</target>

	<target name="test" depends="compile">
		<junit fork="true" failureproperty="junit.tests.failure" errorproperty="junit.tests.error">
			<formatter type="plain" usefile="false" />
			<classpath>
				<path location="${bin}" />
				<path location="${tests.bin}" />
				<path location="${tests.src}" />
				<path><fileset dir="${tests.lib}" includes="*.jar" /></path>
				<path refid="junit.classpath" />
			</classpath>
			<batchtest>
				<fileset dir="${tests.src}">
					<include name="**/*Test*.java" />
					<exclude name="**/Abstract*.java" />
				</fileset>
			</batchtest>
		</junit>
		<fail message="Tests failed" if="junit.test.error" />
		<fail message="Tests failed" if="junit.tests.failure" />
	</target>
	
	<target name="all" depends="jar, docs, check, test" />

</project>
